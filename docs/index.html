<!DOCTYPE html>
<html>

<head>
    <title>Homecare Participatory Housing Map</title>

    <script src="https://unpkg.com/maplibre-gl@3.1.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.1.0/dist/maplibre-gl.css" rel="stylesheet" />

    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        #info {
            position: absolute;
            top: 0;
            left: 0;
            width: 350px;
            margin: 10px;
            padding: 10px;
            background-color: #ffffff;
            border-radius: 5px;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 12px;
            line-height: 1.5;
            z-index: 1;
        }

        #popup { padding: 10px; }
        #name, #content { width: 100%; margin-bottom: 10px; }
        #submit { float: right; }
    </style>
</head>

<body>

<div id="map"></div>

<div id="info">
    <h3>Homecare Housing Map</h3>
    <p>
        Click anywhere to add a housing entry.
        Existing approved housings appear as markers.
    </p>
</div>

<script>

let popup = null;

// Create map
let map = new maplibregl.Map({
    container: 'map',
    style: 'https://api.maptiler.com/maps/dataviz-v4/style.json?key=MlAhLKRr06cWfIoZbbvT',
    center: [-98.5795, 39.8283],
    zoom: 3
});


// ===========================
// LOAD HOUSING DATA
// ===========================
map.on("load", async function () {

    try {
        let response = await fetch('https://homecareapp-5258d509b4b7.herokuapp.com/api/get-housings');
        let data = await response.json();

        data.forEach(house => {

            new maplibregl.Marker({ color: 'red' })
                .setLngLat([house.lng, house.lat])
                .setPopup(new maplibregl.Popup().setHTML(`
                    <strong>${house.title}</strong><br>
                    ${house.description}<br>
                    Price: $${house.price}<br>
                    Added by: ${house.contributor}
                `))
                .addTo(map);

        });

    } catch (err) {
        console.error("Error fetching housing data:", err);
    }
});


// ===========================
// CLICK TO ADD NEW RECORD
// ===========================
map.on('click', function (e) {

    if (popup) popup.remove();

    const popupContent = `
        <div id="popup">
            <input type="text" id="name" placeholder="Your name"><br>
            <input type="text" id="content" placeholder="Description"><br>
            <button id="submit">Submit</button>
        </div>
    `;

    popup = new maplibregl.Popup({ closeOnClick: false })
        .setLngLat(e.lngLat)
        .setHTML(popupContent)
        .addTo(map);

    document.getElementById('submit').addEventListener('click', submitNewRecord);
});


// ===========================
// SUBMIT NEW RECORD TO API
// ===========================
async function submitNewRecord() {

    let contributor = document.getElementById('name').value;
    let content = document.getElementById('content').value;
    let lngLat = popup.getLngLat();

    let newRecord = new URLSearchParams();
    newRecord.append('contributor', contributor);
    newRecord.append('content', content);
    newRecord.append('lng', lngLat.lng);
    newRecord.append('lat', lngLat.lat);

    try {
        await fetch('https://homecareapp-5258d509b4b7.herokuapp.com/api/add-record', {
            method: 'POST',
            body: newRecord
        });

        // Add marker immediately after submit
        new maplibregl.Marker({ color: 'orange' })
            .setLngLat([lngLat.lng, lngLat.lat])
            .setPopup(new maplibregl.Popup().setHTML(`
                <strong>${contributor}</strong><br>${content}
            `))
            .addTo(map);

    } catch (err) {
        console.error(err);
    } finally {
        popup.remove();
    }
}

</script>

</body>
</html>
