<!DOCTYPE html>
<html>

<head>
    <title>Homecare Participatory Housing Map</title>
    <script src="https://unpkg.com/maplibre-gl@3.1.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.1.0/dist/maplibre-gl.css" rel="stylesheet" />

    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        #info {
            position: absolute;
            top: 0;
            left: 0;
            width: 350px;
            margin: 10px;
            padding: 10px;
            background-color: #ffffff;
            border-radius: 5px;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 12px;
            line-height: 1.5;
            z-index: 1;
        }

        #popup input { width: 100%; margin-bottom: 5px; }
        #popup button { float: right; }
    </style>
</head>

<body>
<div id="map"></div>

<div id="info">
    <h3>Homecare Housing Map</h3>
    <p>Click anywhere to add a housing entry.</p>
</div>

<script>
let popup = null;

// Create map
let map = new maplibregl.Map({
    container: 'map',
    style: 'https://api.maptiler.com/maps/dataviz-v4/style.json?key=MlAhLKRr06cWfIoZbbvT',
    center: [-98.5795, 39.8283],
    zoom: 3
});

// ===========================
// LOAD HOUSING DATA
// ===========================
map.on("load", async function () {
    try {
        let response = await fetch('https://homecareapp-5258d509b4b7.herokuapp.com/api/get-housings');
        let data = await response.json();

        data.forEach(house => {
            new maplibregl.Marker({ color: 'red' })
                .setLngLat([house.lng, house.lat])
                .setPopup(new maplibregl.Popup().setHTML(`
                    <strong>${house.title}</strong><br>
                    ${house.description}<br>
                    Price: $${house.price}<br>
                    Added by: ${house.contributor}
                `))
                .addTo(map);
        });
    } catch (err) {
        console.error("Error fetching housing data:", err);
    }
});

// ===========================
// CLICK TO ADD NEW HOUSING
// ===========================
map.on('click', function (e) {
    if (popup) popup.remove();

    const popupContent = `
        <div id="popup">
            <input type="text" id="contributor" placeholder="Your name">
            <input type="text" id="title" placeholder="Title">
            <input type="text" id="description" placeholder="Description">
            <input type="number" id="price" placeholder="Price">
            <button id="submit">Submit</button>
        </div>
    `;

    popup = new maplibregl.Popup({ closeOnClick: false })
        .setLngLat(e.lngLat)
        .setHTML(popupContent)
        .addTo(map);

    document.getElementById('submit').addEventListener('click', submitNewHousing);
});

// ===========================
// SUBMIT NEW HOUSING TO API
// ===========================
async function submitNewHousing() {
    const contributor = document.getElementById('contributor').value;
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    const price = parseFloat(document.getElementById('price').value);
    const lngLat = popup.getLngLat();

    const payload = {
        contributor,
        title,
        description,
        price,
        lat: lngLat.lat,
        lng: lngLat.lng
    };

    try {
        const response = await fetch('https://homecareapp-5258d509b4b7.herokuapp.com/api/add-housing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const newHouse = await response.json();

        // Add marker immediately
        new maplibregl.Marker({ color: 'orange' })
            .setLngLat([newHouse.lng, newHouse.lat])
            .setPopup(new maplibregl.Popup().setHTML(`
                <strong>${newHouse.title}</strong><br>
                ${newHouse.description}<br>
                Price: $${newHouse.price}<br>
                Added by: ${newHouse.contributor}
            `))
            .addTo(map);

    } catch (err) {
        console.error("Error adding new housing:", err);
    } finally {
        popup.remove();
    }
}
</script>

</body>
</html>
