<!DOCTYPE html>
<html>
<head>
    <title>Homecare Participatory Housing Map</title>

    <script src="https://unpkg.com/maplibre-gl@3.1.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.1.0/dist/maplibre-gl.css" rel="stylesheet" />

    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 350px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 13px;
            z-index: 1;
        }

        #info button {
            margin-top: 6px;
            padding: 6px 10px;
            background-color: #6b3fd6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #info button:hover { background-color: #4b26a0; }

        .maplibregl-popup-content {
            font-family: Arial, Helvetica, sans-serif;
            padding: 16px 18px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            min-width: 240px;
            font-size: 13px;
        }

        .maplibregl-popup-content strong {
            font-size: 16px;
            display: block;
            margin-bottom: 6px;
        }

        .popup-price {
            color: #6b3fd6;
            font-weight: bold;
            margin-top: 6px;
        }

        .popup-author {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 6px;
        }

        .housing-marker {
            background-image: url('../img/home.png');
            background-size: contain;
            background-repeat: no-repeat;
            width: 40px;
            height: 40px;
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease;
        }

        .housing-marker:hover {
            transform: scale(1.3);
            filter: drop-shadow(0 0 6px rgba(107,63,214,0.7));
        }

        #popup input {
            width: 100%;
            margin-bottom: 6px;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        #popup button {
            float: right;
            padding: 6px 12px;
            background-color: #6b3fd6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #popup button:hover { background-color: #4b26a0; }
    </style>
</head>
<body>
<div id="map"></div>

<div id="info">
    <h3>Homecare Housing Map</h3>
    <p>Click on the map to add housing at your location.</p>
    <button id="addByAddressBtn">Add Housing by Address</button>
</div>

<script>
let popup = null;
let openMarkerPopup = null;

// Format price with commas
function formatPrice(num) { return num ? num.toLocaleString() : ''; }

// CREATE MAP
const map = new maplibregl.Map({
    container: 'map',
    style: 'https://api.maptiler.com/maps/dataviz-v4/style.json?key=MlAhLKRr06cWfIoZbbvT',
    center: [-98.5795, 39.8283],
    zoom: 3
});

// ===========================
// CREATE MARKER FUNCTION
// ===========================
function createMarker(data, showPopup=false) {
    const el = document.createElement('div');
    el.className = 'housing-marker';

    const markerPopup = new maplibregl.Popup({ offset: 25 }).setHTML(`
        <strong>${data.title || "Housing"}</strong>
        <div>${data.description || ""}</div>
        <div class="popup-price">$${formatPrice(data.price)}</div>
        <div class="popup-author">Added by ${data.contributor || "Unknown"}</div>
    `);

    el.addEventListener('click', e => {
        e.stopPropagation();
        // Close previously open popup
        if(openMarkerPopup && openMarkerPopup !== markerPopup) openMarkerPopup.remove();
        // Toggle this popup
        if(markerPopup.isOpen()) markerPopup.remove();
        else markerPopup.addTo(map);
        openMarkerPopup = markerPopup.isOpen() ? markerPopup : null;
    });

    new maplibregl.Marker({ element: el })
        .setLngLat([data.lng, data.lat])
        .setPopup(markerPopup)
        .addTo(map);

    if(showPopup) {
        // Close old popup first
        if(openMarkerPopup) openMarkerPopup.remove();
        markerPopup.addTo(map);
        openMarkerPopup = markerPopup;
        map.flyTo({ center: [data.lng, data.lat], zoom: 10 });
    }
}

// ===========================
// LOAD EXISTING HOUSING
// ===========================
map.on("load", async () => {
    try {
        const response = await fetch('https://homecareapp-5258d509b4b7.herokuapp.com/api/get-housings');
        if (!response.ok) throw new Error("Server error");
        const data = await response.json();
        data.forEach(house => createMarker(house));
    } catch (err) {
        console.error("Error fetching housing data:", err);
    }
});

// ===========================
// QUICK ADD HOUSING (by map click)
// ===========================
map.on('click', async e => {
    if(popup) popup.remove();
    if(e.originalEvent.target.closest('.housing-marker')) return;

    const lat = e.lngLat.lat;
    const lng = e.lngLat.lng;

    const content = `
        <div id="popup">
            <input type="text" id="contributor" placeholder="Your Name">
            <input type="text" id="title" placeholder="Homecare Name">
            <input type="text" id="description" placeholder="Description">
            <input type="number" id="price" placeholder="Price">
            <button id="submitBtn">Add Housing</button>
        </div>
    `;

    popup = new maplibregl.Popup({ closeOnClick: false })
        .setLngLat([lng, lat])
        .setHTML(content)
        .addTo(map);

    setTimeout(() => {
        document.getElementById('submitBtn').addEventListener('click', () => submitHousing(lat, lng));
    }, 50);
});

// ===========================
// ADD HOUSING BY ADDRESS
// ===========================
document.getElementById('addByAddressBtn').addEventListener('click', () => {
    if(popup) popup.remove();

    const content = `
        <div id="popup">
            <input type="text" id="contributor" placeholder="Your Name">
            <input type="text" id="title" placeholder="Homecare Name">
            <input type="text" id="description" placeholder="Description">
            <input type="number" id="price" placeholder="Price">
            <input type="text" id="address" placeholder="Street Address">
            <input type="text" id="city" placeholder="City">
            <input type="text" id="state" placeholder="State">
            <input type="text" id="zip" placeholder="Zip Code">
            <button id="submitBtn">Add Housing</button>
        </div>
    `;

    popup = new maplibregl.Popup({ closeOnClick: false })
        .setLngLat(map.getCenter())
        .setHTML(content)
        .addTo(map);

    setTimeout(() => {
        document.getElementById('submitBtn').addEventListener('click', submitHousingByAddress);
    }, 50);
});

// ===========================
// SUBMIT HOUSING (quick add)
// ===========================
async function submitHousing(lat, lng) {
    if(!popup) return;

    const contributor = document.getElementById('contributor').value;
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    const price = parseFloat(document.getElementById('price').value);

    const payload = { contributor, title, description, price, lat, lng };

    try {
        const response = await fetch('https://homecareapp-5258d509b4b7.herokuapp.com/api/add-housing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (!response.ok) { alert("Failed to add housing"); return; }

        createMarker(result, true);
    } catch (err) {
        console.error(err); alert("Could not connect to server.");
    }

    popup.remove();
}

// ===========================
// SUBMIT HOUSING BY ADDRESS
// ===========================
async function submitHousingByAddress() {
    if(!popup) return;

    const contributor = document.getElementById('contributor').value;
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    const price = parseFloat(document.getElementById('price').value);
    const address = document.getElementById('address').value;
    const city = document.getElementById('city').value;
    const state = document.getElementById('state').value;
    const zip = document.getElementById('zip').value;

    const fullAddress = `${address}, ${city}, ${state} ${zip}`;
    const key = 'MlAhLKRr06cWfIoZbbvT';

    try {
        const geoRes = await fetch(`https://api.maptiler.com/geocoding/${encodeURIComponent(fullAddress)}.json?key=${key}`);
        const geoData = await geoRes.json();
        if(!geoData.features || geoData.features.length === 0){ alert("Address not found."); return; }

        const [lng, lat] = geoData.features[0].geometry.coordinates;
        const payload = { contributor, title, description, price, address, city, state, zip, lat, lng };

        const response = await fetch('https://homecareapp-5258d509b4b7.herokuapp.com/api/add-housing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        if(!response.ok){ alert("Failed to add housing."); return; }

        createMarker(result, true);
    } catch(err) {
        console.error(err); alert("Could not connect or geocode address.");
    }

    popup.remove();
}
</script>
</body>
</html>
